<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>来用Vite+React快速开发浏览器插件 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/space/assets/css/0.styles.44c8a9cb.css" as="style"><link rel="preload" href="/space/assets/js/app.c334109e.js" as="script"><link rel="preload" href="/space/assets/js/2.733019b2.js" as="script"><link rel="preload" href="/space/assets/js/12.b9c16781.js" as="script"><link rel="prefetch" href="/space/assets/js/10.d3dbcd01.js"><link rel="prefetch" href="/space/assets/js/11.419a1f1a.js"><link rel="prefetch" href="/space/assets/js/13.e25e3787.js"><link rel="prefetch" href="/space/assets/js/14.b4f61ea2.js"><link rel="prefetch" href="/space/assets/js/15.bebbaa9f.js"><link rel="prefetch" href="/space/assets/js/16.c43e8ad7.js"><link rel="prefetch" href="/space/assets/js/17.f2e1347b.js"><link rel="prefetch" href="/space/assets/js/18.5d362097.js"><link rel="prefetch" href="/space/assets/js/19.efd9e707.js"><link rel="prefetch" href="/space/assets/js/20.19342614.js"><link rel="prefetch" href="/space/assets/js/21.c4132e43.js"><link rel="prefetch" href="/space/assets/js/22.c8d95e73.js"><link rel="prefetch" href="/space/assets/js/23.9a276b89.js"><link rel="prefetch" href="/space/assets/js/24.90abfcc9.js"><link rel="prefetch" href="/space/assets/js/25.1da64438.js"><link rel="prefetch" href="/space/assets/js/26.e8493b44.js"><link rel="prefetch" href="/space/assets/js/27.7b13507c.js"><link rel="prefetch" href="/space/assets/js/3.40aa7a3d.js"><link rel="prefetch" href="/space/assets/js/4.da3ef268.js"><link rel="prefetch" href="/space/assets/js/5.dac787d8.js"><link rel="prefetch" href="/space/assets/js/6.820ab661.js"><link rel="prefetch" href="/space/assets/js/7.b04aeb28.js"><link rel="prefetch" href="/space/assets/js/8.8733fc27.js"><link rel="prefetch" href="/space/assets/js/9.76eb16d3.js">
    <link rel="stylesheet" href="/space/assets/css/0.styles.44c8a9cb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/space/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/space/blog/" aria-current="page" class="sidebar-link">简介</a></li><li><a href="/space/blog/15.html" class="sidebar-link">🐵好让人傻傻分不清—JS篇</a></li><li><a href="/space/blog/14.html" class="sidebar-link">🐭好让人傻傻分不清—DOM篇</a></li><li><a href="/space/blog/13.html" class="sidebar-link">🐯好让人傻傻分不清—CSS篇</a></li><li><a href="/space/blog/12.html" class="sidebar-link">这么多年你还在怕正则吗？</a></li><li><a href="/space/blog/11.html" aria-current="page" class="active sidebar-link">来用Vite+React快速开发浏览器插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/space/blog/11.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/space/blog/11.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/space/blog/11.html#组成结构" class="sidebar-link">组成结构</a></li><li class="sidebar-sub-header"><a href="/space/blog/11.html#加载与调试" class="sidebar-link">加载与调试</a></li><li class="sidebar-sub-header"><a href="/space/blog/11.html#模块间通信" class="sidebar-link">模块间通信</a></li><li class="sidebar-sub-header"><a href="/space/blog/11.html#打包发布" class="sidebar-link">打包发布</a></li><li class="sidebar-sub-header"><a href="/space/blog/11.html#结束语" class="sidebar-link">结束语</a></li></ul></li><li><a href="/space/blog/10.html" class="sidebar-link">众所周知的浏览器调试操作</a></li><li><a href="/space/blog/9.html" class="sidebar-link">简单的元素滚动组件</a></li><li><a href="/space/blog/8.html" class="sidebar-link">来一个简单二维码生成器</a></li><li><a href="/space/blog/7.html" class="sidebar-link">用 CSS 找回童年的快乐，哆啦A梦伴你同行</a></li><li><a href="/space/blog/6.html" class="sidebar-link">520， 学废 new 对象的过程</a></li><li><a href="/space/blog/5.html" class="sidebar-link">这个&quot;this&quot;到底是什么</a></li><li><a href="/space/blog/4.html" class="sidebar-link">10 分钟掌握浏览器运行 JS 的顺序</a></li><li><a href="/space/blog/3.html" class="sidebar-link">防抖节流看这篇就够了</a></li><li><a href="/space/blog/2.html" class="sidebar-link">是时候用闭包实现一个缓存函数了</a></li><li><a href="/space/blog/1.html" class="sidebar-link">不得不知的闭包</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="来用vite-react快速开发浏览器插件"><a href="#来用vite-react快速开发浏览器插件" class="header-anchor">#</a> 来用Vite+React快速开发浏览器插件</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>每当看到好的文章或者好的视频，底下总有那么一些长得好看，说话有好听的人才。没有文化的我只能默默的留下不争气的“卧槽，牛逼！</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/30be24c37ebd4efd9bf581e71c8ffc56~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p>同样是腰间盘，为何汝如此突出。同样九年义务教育，为何汝如此优秀。痛定思痛，我决定要向他们学习。于是秉着收藏即学会的原则，我要用 React &amp; Antd  &amp; Vite 快速做一个 chrome 扩展程序(常用名：插件) -- 语录收藏。大体的功能是可以选中一段话，右键可以保存到个人语录中。点击输入框会将所有保存的语录弹窗显示，可供我们快捷输入。点击插件会随机显示一段心灵鸡汤，可以随时补充语录。</p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <div class="language-powershell extra-class"><pre class="language-powershell"><code>yarn create vite my-extension <span class="token operator">--</span>template react-ts
</code></pre></div><p>我们先创建一个 <code>react-ts</code> 的工程</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>yarn add antd
</code></pre></div><p>接着安装完 <code>antd</code>之后，我们就可以开始下面的工作了</p> <h3 id="改造多页面配置"><a href="#改造多页面配置" class="header-anchor">#</a> 改造多页面配置</h3> <p>根据 <a href="https://cn.vitejs.dev/guide/build.html#multi-page-app" target="_blank" rel="noopener noreferrer">Vite 官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 把它改造成一个多页面的工程。多页面的 <code>vite.config.ts</code> 如下：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vite&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> react <span class="token keyword">from</span> <span class="token string">&quot;@vitejs/plugin-react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> path<span class="token punctuation">,</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> makeManifest <span class="token keyword">from</span> <span class="token string">&quot;./utils/plugins/make-manifest&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> customDynamicImport <span class="token keyword">from</span> <span class="token string">'./utils/plugins/custom-dynamic-import'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> vitePluginImp <span class="token keyword">from</span> <span class="token string">'vite-plugin-imp'</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;src&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pagesDir <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">&quot;pages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> assetsDir <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">&quot;assets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> publicDir <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;public&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> outDir <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> isDev <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>__DEV__ <span class="token operator">===</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// https://vitejs.dev/config/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;@src&quot;</span><span class="token operator">:</span> root<span class="token punctuation">,</span>
      <span class="token string-property property">&quot;@assets&quot;</span><span class="token operator">:</span> assetsDir<span class="token punctuation">,</span>
      <span class="token string-property property">&quot;@pages&quot;</span><span class="token operator">:</span> pagesDir<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token function">react</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token function">makeManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token function">customDynamicImport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 按需加载配置</span>
    <span class="token function">vitePluginImp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      libList<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          libName<span class="token operator">:</span> <span class="token string">&quot;antd&quot;</span><span class="token punctuation">,</span>
          <span class="token function-variable function">style</span><span class="token operator">:</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">antd/es/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/style</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  publicDir<span class="token punctuation">,</span>
  build<span class="token operator">:</span> <span class="token punctuation">{</span>
    outDir<span class="token punctuation">,</span>
    sourcemap<span class="token operator">:</span> isDev<span class="token punctuation">,</span>
    rollupOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      input<span class="token operator">:</span> <span class="token punctuation">{</span>
        popup<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>pagesDir<span class="token punctuation">,</span> <span class="token string">&quot;popup&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>pagesDir<span class="token punctuation">,</span> <span class="token string">&quot;options&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        background<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>pagesDir<span class="token punctuation">,</span> <span class="token string">&quot;background&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;index.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// content 需要在 manifest 中指定 css 资源</span>
        content<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>pagesDir<span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;index.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        contentStyle<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>pagesDir<span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;style.less&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      output<span class="token operator">:</span> <span class="token punctuation">{</span>
        entryFileNames<span class="token operator">:</span> <span class="token string">&quot;src/pages/[name]/index.js&quot;</span><span class="token punctuation">,</span>
        chunkFileNames<span class="token operator">:</span> isDev
          <span class="token operator">?</span> <span class="token string">&quot;assets/js/[name].js&quot;</span>
          <span class="token operator">:</span> <span class="token string">&quot;assets/js/[name].[hash].js&quot;</span><span class="token punctuation">,</span>
        assetFileNames<span class="token operator">:</span> <span class="token punctuation">(</span>assetInfo<span class="token operator">:</span> <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
          source<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> Uint8Array<span class="token punctuation">;</span>
          type<span class="token operator">:</span> <span class="token string">'asset'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> dir<span class="token punctuation">,</span> name<span class="token operator">:</span> _name <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>assetInfo<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> assetFolder <span class="token operator">=</span> <span class="token function">getLastElement</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> name <span class="token operator">=</span> assetFolder <span class="token operator">+</span> <span class="token function">firstUpperCase</span><span class="token punctuation">(</span>_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">assets/[ext]/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.chunk.[ext]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  css<span class="token operator">:</span> <span class="token punctuation">{</span>
    preprocessorOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      less<span class="token operator">:</span> <span class="token punctuation">{</span>
        javascriptEnabled<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        modifyVars<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">'@primary-color'</span><span class="token operator">:</span> <span class="token string">'#1e80ff'</span><span class="token punctuation">,</span>	<span class="token comment">// 设置 antd 主题色</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">getLastElement</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>array<span class="token operator">:</span> ArrayLike<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">const</span> lastIndex <span class="token operator">=</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> array<span class="token punctuation">[</span>lastIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">firstUpperCase</span><span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> firstAlphabet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">( |^)[a-z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&quot;g&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>firstAlphabet<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token constant">L</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">L</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里有几个点需要注意下：</p> <ul><li>通过 <code>vite-plugin-imp</code> 按需加载 <code>antd</code></li> <li>contentStyle 为 Content script 内容脚本(下文会介绍)指定的样式，需要单独指定</li> <li>make-manifest、custom-dynamic-import 这两个自定义插件分别是为了处理 manifest 和 content 动态导入</li></ul> <h3 id="nodemon-自动更新"><a href="#nodemon-自动更新" class="header-anchor">#</a> Nodemon 自动更新</h3> <p>为了方便我们快捷开发，我们安装一下 nodemon 自动更新</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>yarn global add nodemon
或者
yarn add nodemon <span class="token operator">--</span>dev
</code></pre></div><p>添加 <code>nodemon.json</code> 配置文件</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;__DEV__&quot;</span><span class="token operator">:</span> <span class="token string">&quot;true&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;watch&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utils&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;vite.config.ts&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ext&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsx,css,scss,html,ts&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ignore&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;src/**/*.spec.ts&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exec&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node_modules/.bin/vite build&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，脚手架相关配置搞定了，简简单单，接下来我们要开始插件相关的工作了。</p> <h2 id="组成结构"><a href="#组成结构" class="header-anchor">#</a> 组成结构</h2> <p>首先简单了解一下插件的整体结构，因 V2 版本即将过期，我们直接用 V3 的版本。
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/afd716e221fc4bdea34fce0679febf3b~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p> <p>插件的组成结构取决于它的功能，但是所有扩展都必须有一个 manifest 的清单。以下是插件包含的所有模块：</p> <ul><li><strong>Manifest</strong>：向浏览器提供关于插件的信息，例如可能使用的功能和图标、执行脚本文件等重要的文件。</li> <li><strong>Service worker</strong>：插件事件处理程序，包含了浏览器事件的监听器。可以访问所有的 Chrome api：实现跨域请求、网页截屏、弹出 chrome 通知消息等功能，前提是要在 <code>manifest.json</code> 中声明了所需的权限。</li> <li><strong>Toolbar icon</strong>：浏览器工具栏上显示的插件图标。用户可以单击图标与一个使用弹出框进行交互。</li> <li><strong>UI elements</strong>：用户交互的元素，包括：上面说的点击图标和弹窗、右键菜单、地址栏搜索选择插件、快捷键唤起等，甚至还可以在页面中插入自定义组件。</li> <li><strong>Content script</strong>：内容脚本允许插件将逻辑注入页面，以读取和修改其内容。 内容脚本可以在已加载到浏览器中的页面上下文中执行的 JavaScript，例如上面说的在页面中插入自定义组件。</li> <li><strong>Options page</strong>：顾名思义，就是插件的配置页面，可以对插件进行一些配置操作。</li></ul> <h3 id="manifest"><a href="#manifest" class="header-anchor">#</a> Manifest</h3> <p>官方要求的是 <code>manifest.json</code> 文件，这里先用 js 来代替，编译阶段再转换文件格式。本次开发的配置如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> packageJson <span class="token keyword">from</span> <span class="token string">&quot;../package.json&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ManifestType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@src/manifest-type&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">manifest</span><span class="token operator">:</span> ManifestType <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">manifest_version</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> packageJson<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
  <span class="token literal-property property">version</span><span class="token operator">:</span> packageJson<span class="token punctuation">.</span>version<span class="token punctuation">,</span>	<span class="token comment">// 当前插件版本</span>
  <span class="token literal-property property">description</span><span class="token operator">:</span> packageJson<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
  <span class="token literal-property property">icons</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 不同尺寸使用场景不同,</span>
    <span class="token string-property property">&quot;16&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon16.png&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;32&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon32.png&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;48&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon48.png&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;128&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon128.png&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">background</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">service_worker</span><span class="token operator">:</span> <span class="token string">&quot;src/pages/background/index.js&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">default_popup</span><span class="token operator">:</span> <span class="token string">&quot;src/pages/popup/index.html&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">default_icon</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;16&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon16.png&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;32&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon32.png&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;48&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon48.png&quot;</span><span class="token punctuation">,</span>
      <span class="token string-property property">&quot;128&quot;</span><span class="token operator">:</span> <span class="token string">&quot;icon128.png&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">content_scripts</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">matches</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;all_urls&gt;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">js</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;src/pages/content/index.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// content 样式需要特殊指定，若使用 antd，需要另外添加 antd 部分样式</span>
      <span class="token comment">// css: [&quot;assets/css/contentStyle.chunk.css&quot;],</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options_page</span><span class="token operator">:</span> <span class="token string">&quot;src/pages/options/index.html&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">web_accessible_resources</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">resources</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;assets/js/*.js&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;assets/css/*.css&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">matches</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;*://*/*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">permissions</span><span class="token operator">:</span> <span class="token punctuation">[</span>	<span class="token comment">// 操作 chrome 的权限</span>
    <span class="token string">&quot;storage&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;activeTab&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;scripting&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;contextMenus&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;notifications&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> manifest<span class="token punctuation">;</span>
</code></pre></div><h3 id="ui-elements"><a href="#ui-elements" class="header-anchor">#</a> <strong>UI elements</strong></h3> <p>上面说到 UI 交互大多数就是，点击插件图标弹窗、右键菜单、在页面中插入自定义组件等等。没错，小孩子才做选择，这几种我全要。</p> <h4 id="content"><a href="#content" class="header-anchor">#</a> Content</h4> <p>因 chrome 插件不支持在 content scripts 中使用 module，这里我们使用动态引入。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// src/pages/content/index.ts</span>

<span class="token comment">/**
 * @description
 * chrome 插件不支持在 content scripts 中使用 module
 */</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./components/Content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// src/pages/content/components/Content/index.tsx</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/client&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;@src/pages/content/components/Content/app&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
root<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">&quot;content-view-root&quot;</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">createRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>以下逻辑简单概括起来就是:</p> <ol><li>监听用户聚焦输入框，从 storage 中获取语录集数据，创建一个选择框提供用户选择快捷输入。</li> <li>监听用户选中文本，调用 <code>sendMessage</code> 向 service worker 发送请求，缓存选中内容。右键可以加入选中内容。</li></ol> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// src/pages/content/components/Content/app.tsx</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createPopper <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@popperjs/core/lib/popper-lite.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> preventOverflow <span class="token keyword">from</span> <span class="token string">'@popperjs/core/lib/modifiers/preventOverflow.js'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> focusTargetRef <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useRef</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> toolTargetRef <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useRef</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>sentences<span class="token punctuation">,</span> setSentences<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// capture: true 聚焦事件不会冒泡，但是可以在捕获阶段触发</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> handleFocus<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'blur'</span><span class="token punctuation">,</span> handleBlur<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// 监听文字选中</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;selectionchange&quot;</span><span class="token punctuation">,</span> handleSelectionChange<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> handleFocus<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'blur'</span><span class="token punctuation">,</span> handleBlur<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      document<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;selectionchange&quot;</span><span class="token punctuation">,</span> handleSelectionChange<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleFocus</span><span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只有可编辑元素才弹窗</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> event<span class="token operator">?.</span>target
    <span class="token keyword">if</span><span class="token punctuation">(</span>target<span class="token operator">?.</span>isContentEditable <span class="token operator">||</span> target<span class="token operator">?.</span>tagName <span class="token operator">===</span> <span class="token string">'INPUT'</span> <span class="token operator">||</span> target<span class="token operator">?.</span>tagName <span class="token operator">===</span> <span class="token string">'TEXTAREA'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sentences&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> sentences <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sentences <span class="token operator">||</span> <span class="token operator">!</span>sentences<span class="token operator">?.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token function">setSentences</span><span class="token punctuation">(</span>sentences<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      focusTargetRef<span class="token punctuation">.</span>current <span class="token operator">=</span> target
      <span class="token keyword">const</span> popperInstance <span class="token operator">=</span> <span class="token function">createPopper</span><span class="token punctuation">(</span>target <span class="token keyword">as</span> HTMLElement<span class="token punctuation">,</span> toolTargetRef<span class="token punctuation">.</span>current<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment">// 省略配置</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      toolTargetRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'data-show'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      popperInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleBlur</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      toolTargetRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'data-show'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleSelectionChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取选中文本</span>
    chrome<span class="token operator">?.</span>runtime<span class="token operator">?.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> action<span class="token operator">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>info<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> focusTargetRef<span class="token operator">?.</span>current
    <span class="token keyword">if</span><span class="token punctuation">(</span>target<span class="token operator">?.</span>isContentEditable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      focusTargetRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>innerText <span class="token operator">=</span> info
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>target<span class="token operator">?.</span>tagName <span class="token operator">===</span> <span class="token string">'INPUT'</span> <span class="token operator">||</span> target<span class="token operator">?.</span>tagName <span class="token operator">===</span> <span class="token string">'TEXTAREA'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      focusTargetRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>value <span class="token operator">=</span> info
    <span class="token punctuation">}</span>

    <span class="token comment">// 自定义触发输入事件</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> bubbles<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> cancelable<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    focusTargetRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tooltip<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>toolTargetRef<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span> sentences<span class="token operator">?.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sentence<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>sentence-item<span class="token punctuation">'</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">handleInput</span><span class="token punctuation">(</span>sentence<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>sentence<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="popup"><a href="#popup" class="header-anchor">#</a> Popup</h4> <p>Popup 页面是用户点击插件图标以后出现的弹窗，我们定一个 html 模版页面。
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a25e58c9b9c64e77b2b317bcb9ee5a92~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- src/pages/popup/index.html --&gt;</span>

<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>zh-CN<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>icon<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image/svg+xml<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/react.svg<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Popup<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./index.tsx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>接着引入组件相关页面。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// src/pages/popup/index.tsx</span>

<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/client&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Popup <span class="token keyword">from</span> <span class="token string">&quot;@pages/popup/Popup&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@pages/popup/index.less&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Can not find root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">createRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Popup</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>Popup 组件页面功能也比较简单，主要调用接口获取数据展示、刷新、加入语录集等等。</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// src/pages/popup/Popup.tsx</span>

<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@pages/popup/Popup.less&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Card <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CopyOutlined<span class="token punctuation">,</span> ReloadOutlined<span class="token punctuation">,</span> FileAddOutlined <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@ant-design/icons'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CopyToClipboard <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-copy-to-clipboard'</span>

<span class="token keyword">const</span> <span class="token function-variable function">Popup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>sentence<span class="token punctuation">,</span> setSentence<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">getSentence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getSentence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.oick.cn/dutang/api.php'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token operator">:</span> <span class="token string">'GET'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> nextSentence <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">setSentence</span><span class="token punctuation">(</span>nextSentence<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleAdd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sentences&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> sentences <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> sentences<span class="token operator">:</span> <span class="token punctuation">[</span>sentence<span class="token punctuation">,</span> <span class="token operator">...</span>sentences<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token function-variable function">handleReload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">getSentence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>popup-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Card</span></span> 
        <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> width<span class="token operator">:</span> <span class="token number">300</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
        <span class="token attr-name">actions</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FileAddOutlined</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>add<span class="token punctuation">'</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleAdd<span class="token punctuation">}</span></span><span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">CopyToClipboard</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>copy<span class="token punctuation">&quot;</span></span> <span class="token attr-name">text</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>sentence<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">CopyOutlined</span></span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">CopyToClipboard</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ReloadOutlined</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>reload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleReload<span class="token punctuation">}</span></span><span class="token punctuation">/&gt;</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span></span>
      <span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> minHeight<span class="token operator">:</span> <span class="token number">60</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> sentence <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Card</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Popup<span class="token punctuation">;</span>

</code></pre></div><h4 id="options"><a href="#options" class="header-anchor">#</a> Options</h4> <p>Optinos 页面与 Popup 页面的代码类似就不再赘述，此页面可以通过右键插件图标 -- 选择“选项”进入，页面支持复制、编辑、删除、新增等等，UI 展示如下：
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e949da75051845ff8e25e87777f3bb7d~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p> <h3 id="service-worker"><a href="#service-worker" class="header-anchor">#</a> <strong>Service worker</strong></h3> <p>这部分我们主要用到了插件的 contextMenus 右键菜单、storage 存储数据、notifications 通知等功能，这些功能我们都需要在 Manifest 里配置。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/pages/background/index.ts</span>

<span class="token keyword">let</span> selectedSentence <span class="token operator">=</span> <span class="token string">''</span>

chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onInstalled<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 右键菜单管理</span>
  chrome<span class="token punctuation">.</span>contextMenus<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;normal&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;title&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;新增语录&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">contexts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'selection'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chrome<span class="token punctuation">.</span>contextMenus<span class="token punctuation">.</span>onClicked<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">addSentence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
                                         <span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">addSentence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sentences&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> sentences <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">sentences</span><span class="token operator">:</span> <span class="token punctuation">[</span>selectedSentence<span class="token punctuation">,</span> <span class="token operator">...</span>sentences<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token punctuation">,</span> action <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">===</span> <span class="token string">'add'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      selectedSentence <span class="token operator">=</span> data
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  chrome<span class="token punctuation">.</span>notifications<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'basic'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">iconUrl</span><span class="token operator">:</span> <span class="token string">'./images/icon.png'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'操作成功'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="加载与调试"><a href="#加载与调试" class="header-anchor">#</a> 加载与调试</h2> <h3 id="加载本地插件"><a href="#加载本地插件" class="header-anchor">#</a> 加载本地插件</h3> <p>存放清单文件的目录可以在开发者模式下添加为插件，操作步骤如下：</p> <ol><li>浏览器输入 <code>chrome://extensions</code> 可以打开插件管理页面
<ul><li>另外，可以点击右上角插件管理的图标，在弹窗菜单底部选择管理扩展程序。</li> <li>另外，还可以点击右上角设置按钮，在弹窗菜单中选择更多工具--扩展程序。</li></ul></li> <li>通过点击开发者模式旁边的开关来启用开发人员模式。</li> <li>最后点击左上角加载已解压的扩展程序选择编译好的目录即可成功加载。</li></ol> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a02470be7d3414abba523a75cb22dfc~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p> <h3 id="调试模式"><a href="#调试模式" class="header-anchor">#</a> 调试模式</h3> <p>我们修改了代码以后，<code>nodemon</code> 自动更新以后，我们需要再
对于 background 的调试，可以在插件管理页面上点击 <code>Service Worker</code> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5158f2b3d0b74e54a7a2c9458c494ae2~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png">
对于 Popup、Options、Content 等都是页面，可以在对应的页面上右键选择检查即可，后续的调试步骤和普通页面一样。</p> <h2 id="模块间通信"><a href="#模块间通信" class="header-anchor">#</a> 模块间通信</h2> <p>组件的 <code>background</code>、<code>popup</code>、<code>content</code> 三者之间关系图如下:
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/50846b0975bf42d8b3c276327cbd8696~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p> <ul><li>content script 与 service worker / popup</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token function">sendResponse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token function-variable function">getCurrentTab</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> queryOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">active</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">currentWindow</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> <span class="token punctuation">[</span>tab<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>queryOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> tab<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> chrome<span class="token punctuation">.</span>tabs<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>id<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>popup 与 service worker</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onMessage<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> sendResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token function">sendResponse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d70c501950e439c99054a460175e882~tplv-k3u1fbpfcp-zoom-1.image" alt="未命名.png"></p> <h2 id="打包发布"><a href="#打包发布" class="header-anchor">#</a> 打包发布</h2> <p>发布脚本主要做了以下几个操作：</p> <ul><li><strong>版本号更新</strong> <ul><li>使用 <code>node-semver</code> 升级版本号</li> <li>使用 <code>sed</code> 命令修改文件，<code>node fs</code> 也行</li></ul></li> <li>构建完了之后要<strong>压缩整个 dist，必须要压缩才能发布到 Chrome Extension Store</strong></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// build.mjs</span>

#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env zx

<span class="token keyword">const</span> semverInc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'semver/functions/inc'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// let {version} = await fs.readJson('./package.json')</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  chalk<span class="token punctuation">.</span>yellow<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Current verion: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJson<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'major'</span><span class="token punctuation">,</span> <span class="token string">'minor'</span><span class="token punctuation">,</span> <span class="token string">'patch'</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">question</span><span class="token punctuation">(</span>
  chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>
    <span class="token string">'Release type? Press Tab twice for suggestion \n'</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">choices</span><span class="token operator">:</span> types<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">let</span> version <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!==</span> <span class="token string">''</span> <span class="token operator">||</span> types<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  version <span class="token operator">=</span> <span class="token function">semverInc</span><span class="token punctuation">(</span>packageJson<span class="token punctuation">.</span>version<span class="token punctuation">,</span> type<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    chalk<span class="token punctuation">.</span>green<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Release verion? </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 使用 sed 命令修改 version，用 node fs 修改也行</span>
  $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sed -i '' s/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageJson<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/g package.json</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">exit 1</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

<span class="token comment">// 构建</span>
<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">tsc &amp;&amp; vite build</span><span class="token template-punctuation string">`</span></span>

<span class="token comment">// git</span>
<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">git add .</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">git commit -m 'Update version to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">git tag v</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">git push origin refs/tags/v</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">git push origin HEAD:refs/for/master</span><span class="token template-punctuation string">`</span></span>

<span class="token comment">// 压缩</span>
<span class="token keyword">await</span> $<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">zip -q -r bundle.zip ./dist</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><ul><li><a href="https://chrome.google.com/webstore/devconsole/register?hl=zh-CN" target="_blank" rel="noopener noreferrer">Chrome 应用商店 - 开发者协议<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 开发者需要交纳 5美元，才可以发布代码到 Chrome Extension Store</li></ul> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ae32d15f35b4a9487fb3366c53dbbbe~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <h2 id="结束语"><a href="#结束语" class="header-anchor">#</a> 结束语</h2> <p><a href="https://github.com/guyon-better/quotation" target="_blank" rel="noopener noreferrer">仓库地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
至此一个简单的浏览器插件就开发完成了，大伙有什么疑问的话可以留言相互探讨一下。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/space/blog/12.html" class="prev">
        这么多年你还在怕正则吗？
      </a></span> <span class="next"><a href="/space/blog/10.html">
        众所周知的浏览器调试操作
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/space/assets/js/app.c334109e.js" defer></script><script src="/space/assets/js/2.733019b2.js" defer></script><script src="/space/assets/js/12.b9c16781.js" defer></script>
  </body>
</html>
